<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel JurÃ­dico â€” Supremo Tribunal de Oasis</title>
  <link rel="stylesheet" href="../style.css">
</head>

<body class="bg-paper">

<!-- ðŸ” PROTEÃ‡ÃƒO -->
<script>
  const usuario = JSON.parse(localStorage.getItem("usuario"));
  if (!usuario || usuario.nivel !== "juridico") {
    location.href = "../index.html";
  }
</script>

<header class="header small official">
  <img src="../logo-oasis.png" class="logo small">
  <div class="header-text">
    <h2>ðŸ‘® Painel JurÃ­dico</h2>
    <span>Supremo Tribunal de Oasis</span>
  </div>
</header>

<nav class="nav-bar official">
  <button onclick="mostrarAba('processos')">ðŸ“‚ Processos Abertos</button>
  <button onclick="mostrarAba('historico')">ðŸ“œ HistÃ³rico por CidadÃ£o</button>
  <button onclick="sair()">ðŸšª Sair</button>
</nav>

<main class="content official">

<!-- ================= PROCESSOS ================= -->
<section id="processos" class="aba active">
  <h3>ðŸ“‚ Processos em Andamento</h3>
  <p class="section-desc">
    Todos os tickets abertos organizados por categoria.
  </p>

  <div id="listaProcessos" class="card-list"></div>
</section>

<!-- ================= HISTÃ“RICO ================= -->
<section id="historico" class="aba">
  <h3>ðŸ“œ HistÃ³rico Oficial</h3>
  <div id="historicoBox" class="card-list"></div>
</section>

</main>

<script type="module">
import {
  collection,
  onSnapshot,
  updateDoc,
  doc,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { db } from "../firebase.js";

/* ðŸ” ABAS */
window.mostrarAba = id => {
  document.querySelectorAll(".aba").forEach(a => a.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

/* ðŸšª SAIR */
window.sair = () => {
  localStorage.clear();
  location.href = "../index.html";
};

/* ðŸ“‚ PROCESSOS ABERTOS */
onSnapshot(
  query(collection(db, "tickets"), where("status", "==", "aberto")),
  snap => {
    const box = document.getElementById("listaProcessos");
    box.innerHTML = "";

    snap.forEach(d => {
      const t = d.data();
      box.innerHTML += `
        <div class="price-card">
          <b>${t.categoria}</b><br>
          CidadÃ£o: ${t.nome}<br>
          CID: ${t.cid}<br><br>

          <button onclick="abrirChat('${d.id}')">ðŸ’¬ Abrir Atendimento</button>
          <button onclick="encerrar('${d.id}')">ðŸ”’ Encerrar Ticket</button>
        </div>
      `;
    });
  }
);

/* ðŸ”’ ENCERRAR */
window.encerrar = async id => {
  await updateDoc(doc(db, "tickets", id), {
    status: "encerrado"
  });
  alert("Ticket encerrado com sucesso.");
};

/* ðŸ’¬ CHAT */
window.abrirChat = id => {
  localStorage.setItem("ticketStaff", id);
  location.href = "chat.html";
};

</script>

</body>
</html>
