<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel JurÃ­dico â€” Supremo Tribunal de Oasis</title>
  <link rel="stylesheet" href="../style.css">
</head>

<body class="bg-paper official">

<!-- ğŸ” PROTEÃ‡ÃƒO -->
<script>
  const usuario = JSON.parse(localStorage.getItem("usuario"));
  if (!usuario || usuario.nivel !== "juridico") {
    location.href = "../index.html";
  }
</script>

<header class="header small official">
  <img src="../logo-oasis.png" class="logo small">
  <div class="header-text">
    <h2>ğŸ‘® Painel JurÃ­dico</h2>
    <span>Supremo Tribunal de Oasis</span>
  </div>
</header>

<nav class="nav-bar official">
  <button onclick="mostrarAba('processos')">ğŸ“‚ Processos Abertos</button>
  <button onclick="mostrarAba('historico')">ğŸ“œ HistÃ³rico por CidadÃ£o</button>
  <button onclick="sair()">ğŸšª Sair</button>
</nav>

<main class="content official">

<!-- ================= PROCESSOS ================= -->
<section id="processos" class="aba active">
  <h3>ğŸ“‚ Processos em Andamento</h3>
  <p class="section-desc">
    Todos os tickets abertos organizados por categoria.
  </p>

  <div id="listaProcessos" class="card-list"></div>
</section>

<!-- ================= CHAT ================= -->
<section id="chat" class="aba">
  <h3 id="chatTitulo">ğŸ’¬ Atendimento JurÃ­dico</h3>

  <div id="mensagens" class="chat-box official"></div>

  <div class="chat-input official">
    <input id="mensagem" placeholder="Digite sua resposta..." />
    <input type="file" id="arquivo" />
    <button onclick="enviarMensagem()">Enviar</button>
    <button class="btn-secondary" onclick="mostrarAba('processos')">â¬… Voltar</button>
  </div>
</section>

<!-- ================= HISTÃ“RICO ================= -->
<section id="historico" class="aba">
  <h3>ğŸ“œ HistÃ³rico Oficial</h3>
  <div id="historicoBox" class="card-list"></div>
</section>

</main>

<script type="module">
import {
  collection,
  onSnapshot,
  updateDoc,
  doc,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { db } from "../firebase.js";
import { abrirChat } from "./juridico.js";

/* ğŸ” ABAS */
window.mostrarAba = id => {
  document.querySelectorAll(".aba").forEach(a => a.classList.remove("active"));
  document.getElementById(id)?.classList.add("active");
};

/* ğŸšª SAIR */
window.sair = () => {
  localStorage.clear();
  location.href = "../index.html";
};

/* ğŸ“‚ PROCESSOS ABERTOS */
onSnapshot(
  query(collection(db, "tickets"), where("status", "==", "aberto")),
  snap => {
    const box = document.getElementById("listaProcessos");
    box.innerHTML = "";

    snap.forEach(d => {
      const t = d.data();

      box.innerHTML += `
        <div class="price-card">
          <b>${t.categoria}</b><br>
          CidadÃ£o: ${t.nome}<br>
          CID: ${t.cid}<br><br>

          <button onclick="abrirAtendimento('${d.id}', '${t.categoria}', '${t.nome}', '${t.cid}')">
            ğŸ’¬ Abrir Atendimento
          </button>
          <button onclick="encerrar('${d.id}')">
            ğŸ”’ Encerrar Ticket
          </button>
        </div>
      `;
    });
  }
);

/* ğŸ’¬ ABRIR CHAT */
window.abrirAtendimento = (id, categoria, nome, cid) => {
  document.getElementById("chatTitulo").innerText =
    `ğŸ’¬ ${categoria} â€” ${nome} ${cid}`;

  mostrarAba("chat");
  abrirChat(id);
};

/* ğŸ”’ ENCERRAR */
window.encerrar = async id => {
  await updateDoc(doc(db, "tickets", id), {
    status: "encerrado"
  });
  alert("Ticket encerrado com sucesso.");
};
</script>

</body>
</html>
