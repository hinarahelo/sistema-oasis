<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Autenticando ‚Äî Supremo Tribunal de Oasis</title>
</head>
<body>

<script>
(function () {
  try {
    const params = new URLSearchParams(window.location.search);
    const session = params.get("session");
    const nivel = params.get("state"); // cidadao | juridico | coordenacao

    if (!session || !nivel) {
      throw "Par√¢metros inv√°lidos";
    }

    let payload;
    try {
      payload = JSON.parse(atob(session));
    } catch {
      payload = JSON.parse(decodeURIComponent(session));
    }

    if (!payload) {
      throw "Payload inv√°lido";
    }

    /* ======================================================
       üîê FORMATO FINAL PADRONIZADO DO USU√ÅRIO
    ====================================================== */
    const usuario = {
      nome: payload.nome || payload.username || "Usu√°rio",
      cid: payload.cid || payload.id || "0000",
      nivel: nivel
    };

    localStorage.setItem("usuario", JSON.stringify(usuario));

    /* ======================================================
       üîÅ LIMPA URL (SEM QUEBRAR CAMINHO)
    ====================================================== */
    window.history.replaceState(
      {},
      document.title,
      window.location.pathname
    );

    /* ======================================================
       ‚û°Ô∏è REDIRECIONA PARA O FLUXO CORRETO
    ====================================================== */
    location.replace("../welcome.html");

  } catch (e) {
    console.error("Erro de autentica√ß√£o:", e);
    localStorage.removeItem("usuario");
    location.replace("../index.html");
  }
})();
</script>

</body>
</html>
