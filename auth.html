<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Autenticando ‚Äî Supremo Tribunal de Oasis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<p>üîê Finalizando autentica√ß√£o, aguarde...</p>

<script>
(function () {
  try {
    const hash = window.location.hash;
    if (!hash || !hash.startsWith("#user=")) {
      throw "Payload ausente";
    }

    let raw = hash.replace("#user=", "");
    let usuario = null;

    /* üîê TENTA URL ENCODED */
    try {
      usuario = JSON.parse(decodeURIComponent(raw));
    } catch (e) {
      /* üîê TENTA BASE64 */
      try {
        usuario = JSON.parse(atob(raw));
      } catch (e2) {
        throw "Payload inv√°lido";
      }
    }

    if (!usuario || !usuario.id || !usuario.nivel) {
      throw "Estrutura inv√°lida";
    }

    /* NORMALIZA */
    const usuarioFinal = {
      nome: usuario.nome || usuario.username || "Usu√°rio",
      cid: usuario.cid || usuario.id,
      nivel: usuario.nivel
    };

    localStorage.setItem(
      "usuario",
      JSON.stringify(usuarioFinal)
    );

    /* REDIRECIONA SEM LOOP */
    window.location.replace("welcome.html");

  } catch (e) {
    console.error("AUTH ERROR:", e);
    localStorage.removeItem("usuario");
    window.location.replace("index.html");
  }
})();
</script>

</body>
</html>
