<script>
(function () {
  try {
    const hash = window.location.hash;
    if (!hash || !hash.startsWith("#user=")) {
      throw "Payload ausente";
    }

    let raw = hash.replace("#user=", "");
    let payload;

    try {
      payload = JSON.parse(decodeURIComponent(raw));
    } catch {
      payload = JSON.parse(atob(raw));
    }

    if (!payload || !payload.id || !payload.nivel) {
      throw "Usu√°rio inv√°lido";
    }

    // üî• LIMPA QUALQUER LOGIN ANTERIOR
    localStorage.clear();

    // üîí PADR√ÉO √öNICO DE USU√ÅRIO
    const usuario = {
      nome: payload.nome || payload.username || "Usu√°rio",
      cid: payload.id,
      nivel: payload.nivel // cidadao | juridico | coordenacao
    };

    localStorage.setItem("usuario", JSON.stringify(usuario));

    location.replace("welcome.html");

  } catch (e) {
    console.error(e);
    localStorage.clear();
    location.replace("index.html");
  }
})();
</script>
