<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Autenticando...</title>
</head>
<body>
<p>Autenticando, aguarde...</p>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { registrarLog } from "./logs.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6btKxDjOK6VT17DdCS3FvF36Hf_7_TXo",
    authDomain: "sistema-oasis-75979.firebaseapp.com",
    projectId: "sistema-oasis-75979"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  try {
    const params = new URLSearchParams(window.location.search);
    const payload = params.get("user");
    if (!payload) throw new Error();

    const user = JSON.parse(atob(payload));

    const usuario = {
      nome: prompt("Digite seu nome no jogo:"),
      cid: prompt("Digite seu ID no jogo:"),
      nivel: "cidadao"
    };

    localStorage.setItem("usuario", JSON.stringify(usuario));

    await registrarLog(db, {
      tipo: "login",
      usuario: usuario.nome,
      cid: usuario.cid,
      nivel: usuario.nivel
    });

    location.href = "tickets.html";
  } catch {
    localStorage.clear();
    location.href = "index.html";
  }
</script>
</body>
</html>
