<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Autenticando...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <p>üîê Finalizando autentica√ß√£o, aguarde...</p>

  <script>
    try {
      /**
       * O Worker redireciona assim:
       * auth.html#user=BASE64_JSON
       */
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const payload = params.get("user");

      if (!payload) {
        throw new Error("Payload n√£o recebido");
      }

      const usuario = JSON.parse(atob(payload));

      /**
       * Estrutura PADR√ÉO usada em TODO o sistema
       * (script.js, staff.js, dashboard, etc)
       */
      const usuarioFinal = {
        nome: usuario.nome,
        cid: usuario.id,        // ID do Discord vira CID
        nivel: usuario.nivel    // cidadao | staff | coordenacao
      };

      localStorage.setItem("usuario", JSON.stringify(usuarioFinal));

      /**
       * Redirecionamento FINAL
       */
      window.location.href = "tickets.html";

    } catch (e) {
      console.error("Erro na autentica√ß√£o:", e);
      localStorage.clear();
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
